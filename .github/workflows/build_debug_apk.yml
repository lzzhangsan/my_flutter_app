          cd android
          # 首先尝试下载依赖
          ./gradlew --refresh-dependencies --stacktrace
          cd ..
          # 使用--stacktrace参数获取详细错误信息
          flutter build apk --debug --stacktrace

jobs:
  build:
    runs-on: ubuntu-22.04  # 使用稳定的ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'  # 启用Java的内置Gradle缓存

      # 直接下载并安装Gradle，避免Gradle Wrapper的网络问题
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: 7.6.1  # 使用稳定版本的Gradle
          arguments: --stacktrace --info

      # 手动下载gradle-wrapper.jar和gradle分发包，避免自动下载失败
      - name: Prepare Gradle wrapper
        run: |
          mkdir -p ~/.gradle/wrapper/dists
          # 下载gradle-wrapper.jar到项目目录
          curl -L -o android/gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v7.6.1/gradle/wrapper/gradle-wrapper.jar
          # 更新gradle-wrapper.properties以使用本地缓存
          echo "distributionBase=GRADLE_USER_HOME" > android/gradle/wrapper/gradle-wrapper.properties
          echo "distributionPath=wrapper/dists" >> android/gradle/wrapper/gradle-wrapper.properties
          echo "distributionUrl=https\\://services.gradle.org/distributions/gradle-7.6.1-bin.zip" >> android/gradle/wrapper/gradle-wrapper.properties
          echo "zipStoreBase=GRADLE_USER_HOME" >> android/gradle/wrapper/gradle-wrapper.properties
          echo "zipStorePath=wrapper/dists" >> android/gradle/wrapper/gradle-wrapper.properties
          # 将gradlew设为可执行
          chmod +x android/gradlew

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true  # 启用Flutter缓存

      # 配置网络参数
      - name: Configure network settings
        run: |
          mkdir -p ~/.gradle
          cat > ~/.gradle/gradle.properties << EOF
          org.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.caching=true
          systemProp.https.protocols=TLSv1.2,TLSv1.3
          systemProp.http.connectionTimeout=180000
          systemProp.http.socketTimeout=180000
          systemProp.http.keepAlive=false
          EOF

      # 修改build.gradle以使用镜像仓库
      - name: Setup Gradle repositories
        run: |
          cd android
          # 修改项目级build.gradle
          if [ -f build.gradle ]; then
            cat > build.gradle.new << EOF
          buildscript {
              repositories {
                  maven { url 'https://maven.aliyun.com/repository/google' }
                  maven { url 'https://maven.aliyun.com/repository/central' }
                  maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:7.2.0'
                  classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.6.21'
              }
          }

          allprojects {
              repositories {
                  maven { url 'https://maven.aliyun.com/repository/google' }
                  maven { url 'https://maven.aliyun.com/repository/central' }
                  maven { url 'https://maven.aliyun.com/repository/public' }
                  maven { url 'https://jitpack.io' }
              }
          }

          rootProject.buildDir = '../build'
          subprojects {
              project.buildDir = "\${rootProject.buildDir}/\${project.name}"
          }
          subprojects {
              project.evaluationDependsOn(':app')
          }

          tasks.register("clean", Delete) {
              delete rootProject.buildDir
          }
          EOF
            mv build.gradle.new build.gradle
          fi

      - name: Get dependencies
        run: flutter pub get

      # 使用--offline模式构建，避免网络请求
      - name: Build Debug APK
        run: |
          # 尝试3次，每次等待5秒
          for i in 1 2 3; do
            if [ $i -gt 1 ]; then
              echo "Retry $i building APK..."
              sleep 5
            fi
            flutter build apk --debug && break
          done

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7
